<!DOCTYPE html>
<html lang="fr">

<head>
	<meta charset="utf-8" />
	<title>Untitled Document</title>
	<link type="text/css" rel="stylesheet" href="./lib/fontawesome/css/all.css" />
	<link type="text/css" rel="stylesheet" href="./css/main.css" />
	<link type="text/css" rel="stylesheet" href="./lib/bootstrap-4.4.1-dist/css/bootstrap.min.css" />
	<script src='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css' rel='stylesheet' />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
</head>

<body>
	<div>
		<div id='map' style='width: 400px; height: 300px;'></div>
		<ul id="avbEvents">

		</ul>
	</div>
	<footer>
		<div class="d-flex justify-content-around rounded rounded-top">
			<div class="btn-bot border border-bottom-0 h-100 d-inline-block fas fa-glass-cheers"></div>
			<div class="btn-bot border border-bottom-0 h-100 d-inline-block fas fa-map-marked-alt"></div>
			<div class="btn-bot border border-bottom-0 h-100 d-inline-block fas fa-users"></div>
			<div class="btn-bot border border-bottom-0 h-100 d-inline-block fas fa-bars"></div>
		</div>
	</footer>
	<div id="spacer"></div>

	<script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
	<script>
		mapboxgl.accessToken = 'pk.eyJ1IjoiYXZiY29tcHRlIiwiYSI6ImNrNjZuY2Q3ZDFmOGkzb280ZXUzcXJtazMifQ.om3XMBAGEknpmEsBAXC08w';
		let map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v11',
			center: [-0.3707, 49.1829],
			zoom: 12
		});
		map.addControl(new mapboxgl.NavigationControl());

		var mapboxClient = mapboxSdk({
			accessToken: mapboxgl.accessToken
		});

		let avbEvents = []

		function addEvent(val, eventData) {
			mapboxClient.geocoding
				.forwardGeocode({
					query: val,
					autocomplete: false,
					limit: 1
				})
				.send()
				.then(function (response) {
					if (
						response &&
						response.body &&
						response.body.features &&
						response.body.features.length
					) {
						var feature = response.body.features[0];
						let marker = new mapboxgl.Marker();
						marker.setLngLat(feature.center).addTo(map);
						console.log(marker.getElement());
						marker.getElement().dataset.eventid = avbEvents.length;
						avbEvents.push(eventData);
					}
				});
		}

		addEvent('5 Rue Du Gaillon, 14000 Caen, France', {
			place: "Le Baroudeur",
			event: "Karaokée",
			hours: "19h - 23h",
			price: "Gratuit"
		}); // Le Baroudeur
		addEvent('rhumba caen', {
			place: "Le Rhumba",
			event: "Anniversaire du bar",
			hours: "19h - 01h",
			price: "Gratuit"
		});
		addEvent('orient express caen', {
			place: "Orient Express",
			event: "Blindtest",
			hours: "20h - 3h",
			price: "5€"
		});
		addEvent("O'Donnell's Irish Pub, Caen, Calvados 14000, France", {
			place: "O'Donnell's Irish Pub",
			event: "Soirée Embuscade",
			hours: "19h - 02h",
			price: "Gratuit"
		});
		addEvent('vertigo caen', {
			place: "Le Vertigo",
			event: "Apéro'party",
			hours: "18h - 20h",
			price: "Gratuit"
		});

		function intersectRect(r1, r2) {
			return !(r2.left > r1.right ||
				r2.right < r1.left ||
				r2.top > r1.bottom ||
				r2.bottom < r1.top);
		}

		function getVisibleMarkers() {
			var cc = map.getContainer();
			var els = cc.getElementsByClassName('mapboxgl-marker');
			var ccRect = cc.getBoundingClientRect();
			var visibles = [];
			for (var i = 0; i < els.length; i++) {
				var el = els.item(i);
				var elRect = el.getBoundingClientRect();
				intersectRect(ccRect, elRect) && visibles.push(el);
			}
			return visibles;
		}


		let ulAVBEvents = document.querySelector("#avbEvents");

		/*<div class="grid-container">
		<div class="Event"></div>
		<div class="Place"></div>
		<div class="Price"></div>
		<div class="Hours"></div>
		</div>*/

		function createPZone(name, text) {
			let zone = document.createElement("div");
			let textElement = document.createElement("p");
			textElement.appendChild(document.createTextNode(text));
			zone.classList.add(name);
			zone.appendChild(textElement);
			return zone;
		}

		function createEventBox(eventData) {
			console.log("Creating event: " + eventData)
			let eventBox = document.createElement('li');
			let div = document.createElement("div");
			div.appendChild(createPZone("Place", eventData.place));
			div.appendChild(createPZone("EventName", eventData.event));
			div.appendChild(createPZone("Hours", eventData.hours));
			div.appendChild(createPZone("Price", eventData.price));

			div.classList.add("avbEvent");
			eventBox.classList.add("eventContainer");
			eventBox.classList.add("border");
			eventBox.classList.add("rounded")
			eventBox.appendChild(div);
			ulAVBEvents.appendChild(eventBox);
		}

		function updateEventList(markers) {
			let eventIds = [];
			for (const marker of markers) {
				eventIds.push(marker.dataset.eventid)
			}

			while (ulAVBEvents.firstChild) {
				ulAVBEvents.removeChild(ulAVBEvents.firstChild);
			}

			for (const eventId of eventIds) {
				let eventData = avbEvents[parseInt(eventId)];
				createEventBox(eventData);
			}
		}

		map.on('zoomend', function () {
			updateEventList(getVisibleMarkers());
		});
		map.on('moveend', function () {
			updateEventList(getVisibleMarkers());
		});

		updateEventList(getVisibleMarkers());
		``
		`
		map.on('load', function () {
			map.loadImage(
				'https://i.imgur.com/WgWXj11.png',
				function (error, image) {
					if (error) throw error;
					map.addImage('bar', image);
					map.addSource('point', {
						'type': 'geojson',
						'data': {
							'type': 'FeatureCollection',
							'features': [{
								'type': 'Feature',
								'geometry': {
									'type': 'Point',
									'coordinates': [-0.366501, 49.187963]
								}
							}]
						}
					});
					map.addLayer({
						'id': 'points',
						'type': 'symbol',
						'source': 'point',
						'layout': {
							'icon-image': 'bar',
							'icon-size': 0.05
						}
					});
				}
			);
		});
		`
		``
	</script>
</body>

</html>